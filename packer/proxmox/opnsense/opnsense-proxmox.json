{
    "builders": [{
    "type": "proxmox-iso",
      
    "proxmox_url": "https://proxmox.flopo.retropetro.net:8006/api2/json",
    "node": "proxmox",
    "username": "terraform-user@pve!tfe-token",
    "token": "cb3e862a-c126-46f1-963d-ef8b8e0ab7ce",
    "insecure_skip_tls_verify": true,
  
    "vm_name": "opnsense-template",
    "vm_id": "9000",
    "memory": "8192",
    "cores": "2",

    "iso_url": "https://mirrors.nycbug.org/pub/opnsense/releases/25.1/OPNsense-25.1-dvd-amd64.iso.bz2",
    "iso_checksum": "68efe0e5c20bd5fbe42918f000685ec10a1756126e37ca28f187b2ad7e5889ca",
    "iso_storage_pool": "local", 
      
    "network_adapters": [{
        "bridge": "vmbr0"
    }],

    "disks": [{
        "type": "scsi",
        "disk_size": "32G",
        "storage_pool": "local-zfs",
        "storage_pool_type": "zfs"
    }],

    "unmount_iso": true,

    "http_directory": "http",
    "http_port_min": "8100",
    "boot_wait": "10s",

    "boot_command": [
        "1",
        "<wait10><wait><wait10><enter>",
        "<wait><enter>",
        "<wait><enter>",
        "<wait><enter>",
        "<wait><enter>",
        "<wait><enter>",
        "<wait><enter>",
        "<wait10><wait10><wait10><wait10><wait10><wait10><wait10><enter>",
        "<wait10><wait><wait>1<enter>",
        "<wait10><wait10><wait10><wait10><wait10><wait10><wait10><wait10><wait10><wait10><wait10><wait10><wait10>",
        "root<enter>",
        "opnsense<enter>",
        "<wait>8<enter>",
        "<wait5>dhclient em0<enter><wait10>",
        "telnet {{ .HTTPIP }} {{ .HTTPPort }} | sed '1,/^$/d' >/conf/config.xml<wait><enter>",
        "GET /config.xml HTTP/1.0<enter><enter>",
        "echo 'PasswordAuthentication yes' >> /usr/local/etc/ssh/sshd_config<enter>",
        "reboot<enter>"
        ],

    "ssh_username": "root",
    "ssh_password": "opnsense",
    "ssh_timeout": "20m"
    
    }
    ],

    "provisioners": [
      {
        "type": "shell",
        "scripts": [
          "~/dev/IaC/packer/proxmox/opnsense/base.sh"
        ],
        "execute_command": "chmod +x {{ .Path }}; /bin/sh -c '{{ .Vars }} {{ .Path }}'"
      }
    ]
  }
  