---
- name: Ensure NetbootXYZ Root Directory Exists
  ansible.builtin.file:
    path: "{{ docker_compose_generator_output_path }}/netboot_xyz"
    state: directory
    mode: '0755'

- name: Ensure Config Directory Exists
  ansible.builtin.file:
    path: "{{ docker_compose_generator_output_path }}/netboot_xyz/config"
    state: directory
    mode: '0755'

- name: Ensure Menus Directory Exists
  ansible.builtin.file:
    path: "{{ docker_compose_generator_output_path }}/netboot_xyz/config/menus"
    state: directory
    mode: '0755'

- name: Ensure Assets Directory Exists
  ansible.builtin.file:
    path: "{{ docker_compose_generator_output_path }}/netboot_xyz/assets"
    state: directory
    mode: '0755'

- name: Ensure Preseed Directory Exists
  ansible.builtin.file:
    path: "{{ docker_compose_generator_output_path }}/netboot_xyz/assets/preseed"
    state: directory
    mode: '0755'

- name: Synchronize PXE TFTP Files
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/files/pxe/tftp/"
    dest: "{{ docker_compose_generator_output_path }}/netboot_xyz/config/menus/"
    recursive: true
    rsync_opts:
      - "--chmod=D0755,F0644"
  notify: Force Restart NetbootXYZ Container

- name: Synchronize PXE Preseed Files
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/files/pxe/preseed/"
    dest: "{{ docker_compose_generator_output_path }}/netboot_xyz/assets/preseed/"
    recursive: true
    rsync_opts:
      - "--chmod=D0755,F0644"
  notify: Force Restart NetbootXYZ Container

# - name: Generate preseed configuration files
#   template:
#     src: "pxe/preseed/proxmox-pve.cfg.j2"
#     dest: "/var/www/html/pxe/preseed/{{ inventory_hostname }}.cfg"
#     owner: www-data
#     group: www-data
#     mode: '0644'
#   delegate_to: "{{ netboot_server }}"
#   tags:
#     - preseed
#     - config

# - name: Generate iPXE boot files
#   template:
#     src: "pxe/ipxe/host.ipxe.j2"
#     dest: "/var/www/html/pxe/ipxe/{{ inventory_hostname }}.ipxe"
#     owner: www-data
#     group: www-data
#     mode: '0644'
#   delegate_to: "{{ netboot_server }}"
#   tags:
#     - ipxe
#     - config

- name: Force handlers to run immediately
  ansible.builtin.meta: flush_handlers
