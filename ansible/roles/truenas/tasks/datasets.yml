---
# Create all TrueNAS datasets using arensb.truenas collection
- name: Create TrueNAS datasets
  arensb.truenas.filesystem:
    name: "{{ item.path }}"
    state: present
    # Set common ZFS properties for better performance
    compression: "{{ item.compression | default('lz4') }}"
    atime: "{{ item.atime | default('off') }}"
    recordsize: "{{ item.recordsize | default(omit) }}"
    sync: "{{ item.sync | default(omit) }}"
    quota: "{{ item.quota | default(omit) }}"
  loop: "{{ truenas_datasets }}"
  when: truenas_datasets is defined and truenas_datasets | length > 0

# Create subdirectories and set permissions within datasets
# Note: arensb.truenas.filesystem doesn't handle directory permissions,
# so we use TrueNAS API's filesystem/setperm endpoint
- name: Create directories and set permissions within datasets
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}/api/v2.0/filesystem/setperm"
    method: POST
    user: "{{ ansible_user }}"
    password: "{{ ansible_password }}"
    force_basic_auth: true
    body_format: json
    body:
      path: "{{ item.0.path }}/{{ item.1.path }}"
      mode: "{{ item.1.mode }}"
      user: "{{ item.1.owner }}"
      group: "{{ item.1.group }}"
      options:
        recursive: true
    validate_certs: false
    status_code: [200]
  loop: "{{ truenas_datasets | subelements('directories', skip_missing=True) }}"
  when:
    - truenas_datasets is defined
    - item.1.path is defined
    - item.1.path | length > 0
  delegate_to: localhost
