---
# Proxmox Post-Installation Setup Tasks
- name: Correct Proxmox VE sources
  when: proxmox_base_setup_correct_sources | bool
  block:
    - name: Update sources.list
      ansible.builtin.copy:
        dest: /etc/apt/sources.list
        content: |
          deb http://deb.debian.org/debian bookworm main contrib
          deb http://deb.debian.org/debian bookworm-updates main contrib
          deb http://security.debian.org/debian-security bookworm-security main contrib
        mode: '0644'
    - name: Disable non-free firmware warnings
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/no-bookworm-firmware.conf
        content: 'APT::Get::Update::SourceListWarnings::NonFreeFirmware "false";'
        mode: '0644'

- name: Disable 'pve-enterprise' repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/pve-enterprise.list
    content: |
      # deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise
    mode: '0644'
  when: proxmox_base_setup_disable_enterprise_repo | bool

- name: Enable 'pve-no-subscription' repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/pve-install-repo.list
    content: |
      deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
    mode: '0644'
  when: proxmox_base_setup_enable_no_subscription_repo | bool

- name: Correct 'ceph package sources'
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/ceph.list
    content: |
      # deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise
      # deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription
      # deb https://enterprise.proxmox.com/debian/ceph-reef bookworm enterprise
      # deb http://download.proxmox.com/debian/ceph-reef bookworm no-subscription
    mode: '0644'
  when: proxmox_base_setup_correct_ceph_sources | bool

- name: Add 'pvetest' repository and set disabled
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/pvetest-for-beta.list
    content: |
      # deb http://download.proxmox.com/debian/pve bookworm pvetest
    mode: '0644'
  when: proxmox_base_setup_add_pvetest_repo | bool

- name: Disable subscription nag
  when: proxmox_base_setup_disable_subscription_nag | bool
  block:
    - name: Create no-nag script
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/no-nag-script
        content: |
          DPkg::Post-Invoke { "dpkg -V proxmox-widget-toolkit | grep -q '/proxmoxlib\\.js$'; if [ $? -eq 1 ]; then { echo 'Removing subscription nag from UI...'; sed -i '/data\\.status.*{/{s/\\!//;s/active/NoMoreNagging/}' /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js; }; fi"; };
        mode: '0644'

    - name: Reinstall proxmox-widget-toolkit
      ansible.builtin.apt:
        name: proxmox-widget-toolkit
        state: present
        force: true
