# code: language=ansible
---
- name: Configure Plex Server
  hosts: plex
  become: true

  roles:
  #  - role: joenyland.plexmediaserver
    - role: Oefenweb.nfs_client
    - role: geerlingguy.node_exporter

  tasks:
    - name: Include create_users tasks
      ansible.builtin.include_tasks: tasks/create_users_plex.yml

- name: Configure NAS server
  hosts: nas
  become: true

  pre_tasks:
    - name: Include create_users tasks
      ansible.builtin.include_tasks: tasks/create_users_nas.yml

  roles:
    - role: grog.package
    - role: ironicbadger.snapraid
      tags: snapraid
    - role: tigattack.mergerfs
    - role: geerlingguy.docker
    - role: geerlingguy.sanoid
    - role: ironicbadger.docker_compose_generator
    - role: geerlingguy.node_exporter
    - role: prometheus.prometheus.smartctl_exporter

- name: Configure Docker Host server
  hosts: docker
  become: true

  pre_tasks:
    - name: Include create_users tasks
      ansible.builtin.include_tasks: tasks/create_users_docker.yml

  roles:
    - role: grog.package
    - role: geerlingguy.docker
    - role: ironicbadger.docker_compose_generator
    - role: geerlingguy.node_exporter
    - role: Oefenweb.nfs_client

- name: Configure Nextcloud Server
  hosts: nextcloud
  become: true

  pre_tasks:
  #   - name: Include create_users tasks
  #     ansible.builtin.include_tasks: tasks/nextcloud_pre_tasks.yml
  #  - name: Create self-signed certificate, if configured.
  #    ansible.builtin.command: >
  #      openssl req -x509 -nodes -subj '/CN={{ nextcloud_domain }}' -days 365
  #      -newkey rsa:4096 -sha256 -keyout {{ item.key }} -out {{ item.cert }}
  #      creates={{ item.cert }}
  #    with_items: "{{ self_signed_certs }}"

  roles:
    - role: geerlingguy.docker
    - role: ironicbadger.docker_compose_generator
    # - {role: geerlingguy.nginx, tags: ['nginx']}
    # - {role: geerlingguy.mysql, tags: ['mysql']}
    # - {role: geerlingguy.php, tags: ['php']}
    # - {role: nierdz.nextcloud, tags: ['nextcloud']}
    # - role: Oefenweb.nfs_client

- name: Configure Utils Server on VM
  hosts: utils
  become: true
  pre_tasks:
    - name: Ensure mealie config directory exists
      ansible.builtin.file:
        path: /opt/appdata/mealie/config
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Copy mealie.json configuration file
      ansible.builtin.copy:
        src: files/mealie.json
        dest: /opt/appdata/ts-mealie/config/mealie.json
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

  roles:
    - role: geerlingguy.docker
    - role: ironicbadger.docker_compose_generator
