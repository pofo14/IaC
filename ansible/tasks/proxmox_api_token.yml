---
- name: Debug auth response structure (without sensitive data)
  ansible.builtin.debug:
    msg: "Calling : https://{{ ansible_host }}:8006/api2/json/access/ticket with user {{ proxmox_api_user }} and {{ proxmox_api_password is defined | ternary('a password', 'no password (using token)') }}"
  when: pve_auth_debug | default(false)

- name: Get PVE auth cookie
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:8006/api2/json/access/ticket"
    method: POST
    validate_certs: false
    body_format: form-urlencoded
    body:
      username: "{{ proxmox_api_user | default('root@pam') }}"
      password: "{{ proxmox_api_password | default(omit) }}"
    status_code: [200, 401, 403]
  register: pve_auth_cookie
  failed_when: pve_auth_cookie.status != 200
  no_log: true

- name: Debug auth response structure (without sensitive data)
  ansible.builtin.debug:
    msg: "Auth response keys: {{ pve_auth_cookie | dict2items | map(attribute='key') | list }}"
  when: pve_auth_debug | default(false)

- name: TEMPORARY DEBUG - Show sensitive data (REMOVE AFTER DEBUGGING)
  ansible.builtin.debug:
    msg: "{{ pve_auth_cookie.json }}"
  when: pve_auth_debug | default(true)

- name: Get CSRF prevention token directly from auth response
  ansible.builtin.set_fact:
    csrf_token: "{{ pve_auth_cookie.json.data.CSRFPreventionToken }}"
    ticket: "{{ pve_auth_cookie.json.data.ticket }}"
  no_log: true

- name: Debug CSRF token (without showing the actual token)
  ansible.builtin.debug:
    msg: "CSRF token is {{ 'successfully retrieved' if csrf_token is defined else 'NOT available' }}"
  when: pve_auth_debug | default(false)

- name: Check if API tokens exist
  uri:
    url: "https://{{ pve_hostname }}.{{ pve_domain }}:8006/api2/json/access/users/{{ item.user }}@{{ item.realm }}/token"
    method: GET
    user: "{{ proxmox_api_user }}"
    password: "{{ proxmox_api_password }}"
    validate_certs: false
    status_code: [200, 401, 403, 404]
    headers:
      Content-Type: application/json
    return_content: yes
  register: token_check
  loop: "{{ proxmox_api_tokens }}"
  no_log: true
  ignore_errors: true

- name: Delete existing API tokens to force recreation
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:8006/api2/json/access/users/{{ item.user }}@{{ item.realm | default('pve') }}/token/{{ item.token_name }}"
    method: DELETE
    headers:
      Cookie: "PVEAuthCookie={{ ticket }}"
      CSRFPreventionToken: "{{ csrf_token }}"
    validate_certs: false
    status_code: [200, 201, 400, 404]
  register: delete_results
  failed_when: false # Don't fail if token doesn't exist
  loop: "{{ proxmox_api_tokens }}"
  loop_control:
    label: "{{ item.user }}@{{ item.realm | default('pve') }}!{{ item.token_name }}"
  when: token_check.results is defined

- name: Create API tokens for Proxmox users
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:8006/api2/json/access/users/{{ item.user }}@{{ item.realm | default('pve') }}/token/{{ item.token_name }}"
    method: POST
    body_format: json
    body:
      comment: "{{ item.comment | default('API token created by Ansible') }}"
      privsep: "{{ item.privsep | default(0) }}" # 0 for full user permissions
    headers:
      Cookie: "PVEAuthCookie={{ ticket }}"
      CSRFPreventionToken: "{{ csrf_token }}"
    validate_certs: false
    status_code: [200, 201, 400]
  register: token_results
  failed_when:
    - token_results.status != 200
    - token_results.status != 201
    - not (token_results.json.errors is defined and
      token_results.json.errors.tokenid is defined and
      'Token already exists' in token_results.json.errors.tokenid)
  changed_when:
    - token_results.status == 200 or token_results.status == 201
  loop: "{{ proxmox_api_tokens }}"
  loop_control:
    label: "{{ item.user }}@{{ item.realm | default('pve') }}!{{ item.token_name }}"

- name: Display API token information
  ansible.builtin.debug:
    msg: >-
      API token {{ item.item.user }}@{{ item.item.realm | default('pve') }}!{{ item.item.token_name }}
      {% if item.status == 400 %}already exists{% else %}created successfully
      {% if item.json.data is defined and item.json.data.value is defined %}
      . Full token ID: {{ item.item.user }}@{{ item.item.realm | default('pve') }}!{{ item.item.token_name }}, secret: {{ item.json.data.value }}
      {% endif %}
      {% endif %}
  loop: "{{ token_results.results }}"
  loop_control:
    label: "{{ item.item.user }}@{{ item.item.realm | default('pve') }}!{{ item.item.token_name }}"

- name: Determine inventory environment
  ansible.builtin.set_fact:
    inventory_env: "{{ inventory_dir.split('/')[-1] }}"
    vault_password_file: "{{ playbook_dir }}/ansible_vault.pass"
  delegate_to: localhost
  become: false

- name: Ensure vault file directory exists
  ansible.builtin.file:
    path: "{{ playbook_dir }}/inventories/{{ inventory_env }}/group_vars/all"
    state: directory
    mode: "0755"
  delegate_to: localhost
  become: false

- name: Build API token dictionary from results
  ansible.builtin.set_fact:
    api_tokens_dict: "{{ api_tokens_dict | default({}) | combine({item.item.token_name: item.json.data.value}) }}"
  loop: "{{ token_results.results }}"
  loop_control:
    label: "{{ item.item.token_name }}"
  when:
    - item.status is defined
    - (item.status == 200 or item.status == 201)
    - item.json.data is defined
    - item.json.data.value is defined
  delegate_to: localhost
  become: false

- name: Create vault file content with API tokens
  ansible.builtin.copy:
    content: |
      # Proxmox API Tokens for {{ pve_hostname }} - Generated on {{ ansible_date_time.date }}
      # WARNING: This file is encrypted with Ansible Vault
      # DO NOT commit unencrypted version to git

      proxmox_api_tokens_generated:
      {% for token_name, token_value in api_tokens_dict.items() %}
        {{ token_name }}: "{{ token_value }}"
      {% endfor %}
    dest: "{{ playbook_dir }}/inventories/{{ inventory_env }}/group_vars/all/api_tokens_{{ pve_hostname }}.yml"
    mode: "0600"
  delegate_to: localhost
  become: false
  register: vault_file_created
  when: api_tokens_dict is defined

- name: Encrypt the API tokens file with Ansible Vault
  ansible.builtin.command:
    cmd: "ansible-vault encrypt {{ playbook_dir }}/inventories/{{ inventory_env }}/group_vars/all/api_tokens_{{ pve_hostname }}.yml --vault-password-file={{ vault_password_file }} --encrypt-vault-id default"
  delegate_to: localhost
  become: false
  when:
    - vault_file_created.changed
    - api_tokens_dict is defined
  changed_when: false

- name: Display vault file location
  ansible.builtin.debug:
    msg: "API tokens saved to encrypted vault file: inventories/{{ inventory_env }}/group_vars/all/api_tokens_{{ pve_hostname }}.yml"
  when: vault_file_created.changed
