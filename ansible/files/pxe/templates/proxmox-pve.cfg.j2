### Debian (Trixie) preseed for Proxmox-on-Debian (Single Disk, ext4)
### Generated for {{ pve_hostname }}

############################################################
# LOCALE & KEYBOARD
############################################################
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap string us
d-i keyboard-configuration/toggle select No toggling

############################################################
# EARLY COMMAND (no wipe; safe for bare metal)
############################################################
d-i preseed/early_command string true

############################################################
# NETWORKING (installer + system)
############################################################
d-i netcfg/choose_interface select auto
d-i netcfg/disable_autoconfig boolean true
d-i netcfg/disable_dhcp boolean true
d-i netcfg/get_ipaddress string {{ pve_ip }}
d-i netcfg/get_netmask string {{ network_mask }}
d-i netcfg/get_gateway string {{ network_gateway }}
d-i netcfg/get_nameservers string {{ network_dns }}
d-i netcfg/confirm_static boolean true
d-i netcfg/get_hostname string {{ pve_hostname }}
d-i netcfg/get_domain string {{ pve_domain }}

############################################################
# DEBIAN MIRROR
############################################################
d-i mirror/protocol select http
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i mirror/country string manual
d-i mirror/suite string trixie

############################################################
# ACCOUNTS
############################################################
d-i passwd/root-login boolean true
d-i passwd/root-password-crypted password {{ root_password_hash }}

d-i passwd/make-user boolean true
d-i passwd/user-fullname string {{ user_fullname }}
d-i passwd/username string {{ username }}
d-i passwd/user-password-crypted password {{ user_password_hash }}

############################################################
# TIME & LOCALE
############################################################
d-i clock-setup/utc boolean false
d-i time/zone select {{ timezone }}

############################################################
# DISK SELECTION - SIMPLE ATOMIC RECIPE
############################################################
d-i partman-auto/disk string /dev/disk/by-id/{{ os_disk }}
d-i partman-auto/method string regular
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# Use the simplest atomic recipe
d-i partman-auto/choose_recipe select atomic

# Confirm partitioning without prompts
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Use UUIDs for mounting
d-i partman/mount_style select uuid

############################################################
# GRUB INSTALLATION
############################################################
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string /dev/disk/by-id/{{ os_disk }}

############################################################
# APT & PACKAGES
############################################################
d-i apt-setup/disable-cdrom-entries boolean true
d-i apt-setup/services-select multiselect security, updates

tasksel tasksel/first multiselect standard, ssh-server
d-i pkgsel/include string build-essential curl gnupg2 ifupdown2

############################################################
# LATE COMMAND (hostname, SSH keys, networking, sudo)
############################################################
d-i preseed/late_command string \
  echo {{ pve_hostname }} > /target/etc/hostname ; \
  in-target mkdir -p /root/.ssh /home/{{ username }}/.ssh ; \
  in-target sh -c 'curl -s https://github.com/{{ github_username }}.keys > /root/.ssh/authorized_keys' ; \
  in-target install -m 600 /root/.ssh/authorized_keys /home/{{ username }}/.ssh/authorized_keys ; \
  in-target chmod 700 /root/.ssh /home/{{ username }}/.ssh ; \
  in-target chown -R {{ username }}:{{ username }} /home/{{ username }}/.ssh ; \
  in-target sed -i "s/^#\\?PermitRootLogin.*/PermitRootLogin prohibit-password/" /etc/ssh/sshd_config ; \
  in-target sed -i "s/^#\\?PasswordAuthentication.*/PasswordAuthentication no/" /etc/ssh/sshd_config ; \
  in-target sh -c 'echo "{{ username }} ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/{{ username }}' ; \
  in-target chmod 0440 /etc/sudoers.d/{{ username }} ; \
  in-target sh -c 'printf "auto lo\niface lo inet loopback\n\nauto ens18\niface ens18 inet static\n    address {{ pve_ip }}/24\n    gateway {{ network_gateway }}\n    dns-nameservers {{ network_dns }}\n" > /etc/network/interfaces'  ; \
  in-target hostnamectl set-hostname {{ pve_hostname }}.{{ pve_domain }} ; \
  in-target sh -c 'echo "127.0.1.1 {{ pve_hostname }}.{{ pve_domain }} {{ pve_hostname }}" >> /etc/hosts' ; \
  in-target sh -c 'echo "{{ pve_ip }} {{ pve_hostname }}.{{ pve_domain }} {{ pve_hostname }}" >> /etc/hosts' ; \
  in-target systemctl restart networking || true ; \
  in-target systemctl restart ssh || true ;

############################################################
# FINISH
############################################################
d-i finish-install/reboot_in_progress note
