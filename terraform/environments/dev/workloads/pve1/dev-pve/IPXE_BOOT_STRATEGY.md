# iPXE Boot Strategy for Preseed Automation

## Overview

This document outlines the recommended approach for MAC-based iPXE chainloading to automate Debian preseed installations,
bypassing netboot.xyz custom menu limitations.

## The Problem with Netboot.xyz Custom Menus

**Issue:** Netboot.xyz downloads menus from upstream (`boot.netboot.xyz`), making local custom menus difficult to maintain and override.

**Solution:** Use MAC-based iPXE chainloading with fallback to netboot.xyz for general use.

## Recommended Architecture

### Three-Tier Boot Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DHCP Server (192.168.2.1)                                   â”‚
â”‚ - next-server: 192.168.2.7 (Management VM)                  â”‚
â”‚ - filename: undionly.kpxe (BIOS) / ipxe.efi (UEFI)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Primary Boot Script: http://192.168.2.7/ipxe/boot.ipxe     â”‚
â”‚ - Check for MAC-specific menu                                â”‚
â”‚ - Fallback to netboot.xyz for manual boots                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MAC-Specific Menu    â”‚            â”‚ Netboot.xyz           â”‚
â”‚ mac-XX-XX-XX.ipxe    â”‚            â”‚ boot.netboot.xyz      â”‚
â”‚ (Automated Preseed)  â”‚            â”‚ (Manual Selection)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation

### 1. Primary Boot Script

Create `/var/www/html/ipxe/boot.ipxe`:

```ipxe
#!ipxe

# Display boot information
echo ========================================
echo Flopo Infrastructure PXE Boot
echo ========================================
echo MAC Address: ${mac}
echo IP Address: ${ip}
echo Hostname: ${hostname}
echo ========================================

# Try MAC-specific configuration first (for automated preseed)
echo Checking for MAC-specific boot configuration...
chain --autofree http://192.168.2.7/ipxe/mac-${mac:hexhyp}.ipxe ||

# Fall back to netboot.xyz for manual/interactive boots
echo No MAC-specific config found, loading netboot.xyz menu...
chain --autofree https://boot.netboot.xyz/menu.ipxe ||

# Final fallback - error message
echo Failed to load any boot menu!
echo Press any key to reboot...
prompt
reboot
```

### 2. MAC-Specific Preseed Boot File

**Generated by Terraform Output:**

File: `/var/www/html/ipxe/mac-bc-24-11-21-57-b7.ipxe`

```ipxe
#!ipxe

echo ========================================
echo Automated Debian Preseed Installation
echo Target: test-preseed
echo MAC: BC:24:11:21:57:B7
echo ========================================

# Debian 12 (Bookworm) Network Installer
kernel http://ftp.debian.org/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64/linux
initrd http://ftp.debian.org/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64/initrd.gz

# Preseed parameters
imgargs linux auto=true priority=critical \
  url=http://192.168.2.7/preseed/test-preseed.cfg \
  interface=auto \
  hostname=test-preseed \
  domain=flopo.retropetro.net \
  netcfg/get_ipaddress=192.168.2.99 \
  netcfg/get_netmask=255.255.255.0 \
  netcfg/get_gateway=192.168.2.1 \
  netcfg/get_nameservers=192.168.2.2 \
  netcfg/confirm_static=true

boot
```

### 3. Directory Structure

```
/var/www/html/
â”œâ”€â”€ ipxe/
â”‚   â”œâ”€â”€ boot.ipxe                         # Primary boot script
â”‚   â”œâ”€â”€ mac-bc-24-11-21-57-b7.ipxe       # Test VM (generated)
â”‚   â”œâ”€â”€ mac-xx-xx-xx-xx-xx-xx.ipxe       # Dev-pve1 (generated)
â”‚   â””â”€â”€ README.md                         # Documentation
â””â”€â”€ preseed/
    â”œâ”€â”€ test-preseed.cfg                  # Test VM preseed
    â””â”€â”€ dev-pve1.cfg                      # Dev-pve1 preseed
```

## Automation Workflow

### Terraform â†’ Ansible Integration

**Step 1: Terraform Creates VM and Outputs MAC**

```bash
cd /workspaces/IaC/terraform/environments/dev/workloads/pve1/test-preseed
terraform apply
terraform output -json > vm_info.json
```

**Step 2: Ansible Generates iPXE File from Template**

Create Ansible playbook: `ansible/playbooks/generate_ipxe_menu.yml`

```yaml
---
- name: Generate MAC-based iPXE boot files
  hosts: proxmox_hosts
  tasks:
    - name: Ensure iPXE directory exists
      file:
        path: /var/www/html/ipxe
        state: directory
        mode: '0755'
      delegate_to: management.flopo.retropetro.net

    - name: Generate iPXE boot file
      template:
        src: templates/preseed-ipxe.j2
        dest: "/var/www/html/ipxe/mac-{{ mac_address | lower | replace(':', '-') }}.ipxe"
        mode: '0644'
      delegate_to: management.flopo.retropetro.net
      vars:
        mac_address: "{{ hostvars[inventory_hostname]['mac_address'] }}"
```

**Step 3: Boot VM from PXE**

VM boots â†’ DHCP â†’ iPXE â†’ MAC-specific script â†’ Automated installation

## Benefits of This Approach

### âœ… Advantages

1. **Predictable**: Terraform outputs exact MAC address for file naming
2. **Automated**: End-to-end automation from VM creation to installation
3. **Flexible**: Fall back to netboot.xyz for non-preseed boots
4. **Maintainable**: Simple text files, no binary menu compilation
5. **Testable**: Easy to test with `curl` or web browser
6. **Repeatable**: Destroy/recreate VM maintains same workflow

### ðŸš« Avoids

1. No fighting netboot.xyz asset updates
2. No custom menu compilation
3. No upstream dependency for preseed automation
4. No manual intervention required

## Testing the Setup

### 1. Test Primary Boot Script

```bash
curl http://192.168.2.7/ipxe/boot.ipxe
```

### 2. Test MAC-Specific File

```bash
# From Terraform output
MAC_FILE=$(terraform output -raw ipxe_menu_filename)
curl http://192.168.2.7/ipxe/${MAC_FILE}
```

### 3. Test End-to-End

```bash
# Create VM
terraform apply

# Get MAC address
MAC=$(terraform output -raw mac_address)
echo "VM MAC Address: $MAC"

# Create iPXE file (manual or via Ansible)
# ... generate mac-XX-XX-XX-XX-XX-XX.ipxe ...

# Boot VM from network (in Proxmox UI or via CLI)
qm set $(terraform output -raw vm_id) --boot order=net0
qm start $(terraform output -raw vm_id)

# Watch console for automated installation
```

## DHCP Configuration

Update your DHCP server to use the management VM as PXE server:

```
# Example dnsmasq configuration
dhcp-boot=undionly.kpxe,192.168.2.7
dhcp-boot=tag:efi,ipxe.efi,192.168.2.7

# Or ISC DHCP
next-server 192.168.2.7;
filename "undionly.kpxe";
```

## Next Steps

1. **Implement primary boot script** on management VM
2. **Create Ansible playbook** for iPXE file generation
3. **Test with test-preseed VM**
4. **Expand to production** Proxmox hosts
5. **Document MAC addresses** in inventory for tracking

## Alternative: Ansible-Only iPXE Generation

If you prefer pure Ansible without Terraform outputs:

```yaml
# ansible/inventories/dev/host_vars/test-preseed.flopo.retropetro.net.yml
---
pve_hostname: test-preseed
pve_ip: 192.168.2.99
mac_address: "BC:24:11:21:57:B7"  # From Terraform or manually added
storage_disks:
  - scsi-0QEMU_QEMU_HARDDISK_drive-scsi0
  - scsi-0QEMU_QEMU_HARDDISK_drive-scsi1
```

Then Ansible generates both preseed and iPXE files in one playbook run.
